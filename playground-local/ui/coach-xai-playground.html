<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Coach Xai ‚Äì Playground Local</title>
  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 16px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f6f7ff;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }

    .chat-wrapper {
      width: 100%;
      max-width: 800px;
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 14px 40px rgba(15, 23, 42, 0.18);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .chat-header {
      padding: 16px 20px;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(135deg, #3956e8, #7459d9);
      color: #ffffff;
    }

    .chat-header-title {
      font-size: 1.1rem;
      font-weight: 700;
    }

    .chat-header-subtitle {
      font-size: 0.8rem;
      opacity: 0.9;
    }

    .chat-badge {
      font-size: 0.7rem;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.2);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .chat-body {
      padding: 16px;
      height: 420px;
      overflow-y: auto;
      background: #f8fafc;
    }

    .message {
      max-width: 80%;
      margin-bottom: 12px;
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 0.9rem;
      line-height: 1.4;
      white-space: pre-wrap;
    }

    .message.user {
      margin-left: auto;
      background: #3956e8;
      color: #ffffff;
      border-bottom-right-radius: 4px;
    }

    .message.coach {
      margin-right: auto;
      background: #ffffff;
      border: 1px solid #e2e8f0;
      color: #0f172a;
      border-bottom-left-radius: 4px;
    }

    .meta {
      font-size: 0.7rem;
      opacity: 0.7;
      margin-bottom: 4px;
    }

    .meta.user {
      text-align: right;
      margin-right: 2px;
    }

    .meta.coach {
      text-align: left;
      margin-left: 2px;
    }

    .chat-footer {
      padding: 10px 12px;
      border-top: 1px solid #e2e8f0;
      background: #ffffff;
      display: flex;
      gap: 8px;
      align-items: flex-end;
    }

    .chat-input {
      flex: 1;
      border-radius: 999px;
      border: 1px solid #cbd5f5;
      padding: 8px 14px;
      font-size: 0.9rem;
      outline: none;
      resize: none;
      min-height: 40px;
      max-height: 80px;
      line-height: 1.3;
    }

    .chat-input:focus {
      border-color: #3956e8;
      box-shadow: 0 0 0 1px rgba(57, 86, 232, 0.25);
    }

    .chat-send-btn {
      border: none;
      border-radius: 999px;
      padding: 10px 18px;
      background: #3956e8;
      color: #ffffff;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .chat-send-btn:disabled {
      opacity: 0.6;
      cursor: default;
    }

    .chat-send-btn span.icon {
      font-size: 1rem;
      transform: translateY(1px);
    }

    @media (max-width: 600px) {
      .chat-body { height: 60vh; }
      .chat-header-title { font-size: 1rem; }
      .chat-header-subtitle { font-size: 0.75rem; }
    }
  </style>
</head>
<body>
  <div class="chat-wrapper">
    <header class="chat-header">
      <div>
        <div class="chat-header-title">Coach Xai ‚Äì Playground Local</div>
        <div class="chat-header-subtitle">
          Prueba interna de tono y l√≥gica del coach (sin conexi√≥n a APIs).
        </div>
      </div>
      <div class="chat-badge">Modo demo</div>
    </header>

    <main id="chat-body" class="chat-body">
      <div class="meta coach">Coach Xai</div>
      <div class="message coach">
        Bienvenida, bienvenido. üëã  
        Este es un modo demo para probar c√≥mo se ver√≠a la conversaci√≥n con el coach.  
        Escr√≠beme c√≥mo est√° tu situaci√≥n con el dinero o qu√© te preocupa ahora mismo y vamos paso a paso.
      </div>
    </main>

    <form id="chat-form" class="chat-footer">
      <textarea
        id="chat-input"
        class="chat-input"
        placeholder="Escribe aqu√≠ como si fueras el usuario‚Ä¶"
      ></textarea>
      <button type="submit" id="send-btn" class="chat-send-btn">
        <span class="icon">‚û§</span>
        Enviar
      </button>
    </form>
  </div>

<script>
  const chatBody = document.getElementById("chat-body");
  const chatForm = document.getElementById("chat-form");
  const chatInput = document.getElementById("chat-input");
  const sendBtn = document.getElementById("send-btn");

  // üß† memoria conceptual simple
  let lastActiveModule = null;

  function appendMessage(text, role) {
    const meta = document.createElement("div");
    meta.className = "meta " + role;
    meta.textContent = role === "user" ? "Usuario" : "Coach Xai";

    const msg = document.createElement("div");
    msg.className = "message " + role;
    msg.textContent = text;

    chatBody.appendChild(meta);
    chatBody.appendChild(msg);
    chatBody.scrollTop = chatBody.scrollHeight;
  }

  function appendInfo(text) {
    if (!text) return;
    const info = document.createElement("div");
    info.className = "meta coach";
    info.style.fontStyle = "italic";
    info.style.opacity = "0.65";
    info.textContent = text;
    chatBody.appendChild(info);
    chatBody.scrollTop = chatBody.scrollHeight;
  }

  // üß† Detectar m√≥dulos del KB seg√∫n el mensaje del usuario
  function detectarModulos(text) {
    const t = text.toLowerCase()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "");

    const modules = [];

    // RESERVA_EMERGENCIA_XAI
    if (t.includes("reserva") || t.includes("emergencia") || t.includes("fondo") || t.includes("liquidez") || t.includes("meses")) {
      modules.push("RESERVA_EMERGENCIA_XAI");
    }

    // METAS_FINANCIERAS_XAI
    if (
      t.includes("meta") || t.includes("objetivo") ||
      t.includes("viaje") || t.includes("vacacion") ||
      t.includes("casa") || t.includes("propiedad") ||
      t.includes("carro") || t.includes("auto") ||
      t.includes("universidad") || t.includes("colegio") || t.includes("hijo")
    ) {
      modules.push("METAS_FINANCIERAS_XAI");
    }

    // GASTOS_DESVIACIONES_XAI
    if (
      t.includes("gasto") || t.includes("compras") ||
      t.includes("suscripcion") || t.includes("suscripci√≥n") ||
      t.includes("sin darme cuenta") || t.includes("desviacion") ||
      t.includes("desviaci√≥n")
    ) {
      modules.push("GASTOS_DESVIACIONES_XAI");
    }

    // SUPERAVIT_DEFICIT_XAI
    if (
      t.includes("superavit") || t.includes("super√°vit") ||
      t.includes("deficit") || t.includes("d√©ficit") ||
      t.includes("en rojo") || t.includes("rojos") ||
      t.includes("no me alcanza") || t.includes("no llego")
    ) {
      modules.push("SUPERAVIT_DEFICIT_XAI");
    }

    // DEUDAS_XAI
    if (
      t.includes("deuda") || t.includes("tarjeta") ||
      t.includes("prestamo") || t.includes("pr√©stamo") ||
      t.includes("credito") || t.includes("cr√©dito") ||
      t.includes("interes") || t.includes("inter√©s")
    ) {
      modules.push("DEUDAS_XAI");
    }

    // ESTADO_FINANCIERO_XAI
    if (
      t.includes("patrimonio") || t.includes("neto") ||
      t.includes("activos") || t.includes("pasivos") ||
      t.includes("balance") || t.includes("estado financiero")
    ) {
      modules.push("ESTADO_FINANCIERO_XAI");
    }

    // Evitar duplicados
    return [...new Set(modules)];
  }

  // MOCK AFINADO 3.0 ‚Äì devuelve { reply, modules, estadio }
  function mockCoachXai(userMessage) {
    const raw = userMessage.trim();
    const text = raw.toLowerCase()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "");

    const modules = detectarModulos(text);

    // Actualiza m√≥dulo activo si hay uno nuevo
    if (modules && modules.length > 0) {
      lastActiveModule = modules[0]; // dominante
    }

    function pick(arr) {
      return arr[Math.floor(Math.random() * arr.length)];
    }

    // 1) DETECCI√ìN DE EMOCIONES
    const emociones = [
      "estres", "preocup", "ansio", "frustra",
      "cansad", "mal", "abrumad", "agotad", "triste"
    ];
    const detectaEmocion = emociones.some(e => text.includes(e));

    if (detectaEmocion) {
      const aperturas = [
        "Gracias por compartir c√≥mo te sientes. Ese ya es un paso importante. üôè",
        "Aprecio que seas sincero con c√≥mo te est√°s sintiendo, eso cuenta mucho. üôè",
        "Te agradezco que lo digas tal cual. Hablar de esto ya es avanzar. üôè"
      ];

      const cuerpos = [
        "Con el dinero es normal sentirse as√≠ a veces. No est√°s solo en esto.",
        "La presi√≥n financiera es real, y es v√°lido sentirse cargado. Aqu√≠ vamos a poner orden poco a poco.",
        "Lo que sientes tiene sentido. Muchas personas pasan por lo mismo cuando miran sus n√∫meros."
      ];

      return {
        reply:
          pick(aperturas) + "\n\n" +
          pick(cuerpos) + " " +
          "Vamos paso a paso: ¬øqu√© parte de tu situaci√≥n te pesa m√°s ahora mismo: gastos, deudas, ahorro o alguna meta espec√≠fica?",
        modules,
        estadio: null
      };
    }

    // 2) SALUDO CORTO
    const isShort = text.length <= 40;
    const isGreeting = /\b(hola|buenas|hey|saludos|que tal|qu√© tal)\b/.test(text);

    if (isGreeting && isShort) {
      const lineas = [
        "Me alegra que te pases por aqu√≠. üëã",
        "Qu√© bueno verte por aqu√≠. üëã",
        "Bienvenido a este espacio para ver tu dinero con m√°s calma. üëã"
      ];
      const segundas = [
        "Soy Coach Xai y estoy aqu√≠ para ayudarte a entender tus n√∫meros sin juicio, paso a paso.",
        "Soy Coach Xai. Mi trabajo es ayudarte a organizar lo que entra, lo que sale y tus metas.",
        "Soy Coach Xai y te acompa√±o a ver tu dinero con claridad, sin rega√±os y con pasos peque√±os."
      ];
      const cierres = [
        "Para empezar, dime: ¬øte preocupa m√°s lo que gastas, lo que debes o lo que no est√°s ahorrando?",
        "Cu√©ntame, ¬øqu√© te gustar√≠a revisar primero: gastos, deudas, ahorro, ingresos o alguna meta?",
        "Arranquemos por lo b√°sico: ¬øquieres empezar por gastos, deudas, ahorro o metas?"
      ];

      return {
        reply: pick(lineas) + "\n\n" + pick(segundas) + " " + pick(cierres),
        modules,
        estadio: null
      };
    }

    // 3B) COMBINACIONES FUERTES (gastos, deuda, ahorro)
    const mencionaGastos = text.includes("gasto");
    const mencionaDeuda = text.includes("deuda") || text.includes("tarjeta");
    const mencionaAhorro = text.includes("ahorro") || text.includes("poco ahorro") || text.includes("sin ahorro");

    if (mencionaGastos && mencionaDeuda && mencionaAhorro) {
      return {
        reply:
          "Gracias por compartirlo con tanta claridad.\n\n" +
          "Cuando se juntan gastos altos, deuda pesada y poco ahorro, normalmente estamos en una etapa donde la prioridad es estabilizar el flujo y recuperar un poco de espacio para respirar.\n\n" +
          "No vamos a intentar arreglar todo a la vez. El primer paso es elegir un solo punto para revisar esta semana: puede ser una categor√≠a de gasto o tus pagos de deuda.\n\n" +
          "¬øD√≥nde sientes que est√° el mayor peso ahora mismo?",
        modules,
        estadio: "sobreviviendo"
      };
    }

    if (mencionaGastos && mencionaDeuda) {
      return {
        reply:
          "Entiendo. Cuando gastos y deudas se juntan, el peso financiero se siente fuerte.\n\n" +
          "Aqu√≠ lo mejor es empezar por claridad: revisar una sola categor√≠a de gasto y tambi√©n entender cu√°nto pagas al mes en deudas.\n\n" +
          "¬øQuieres empezar por tus gastos o por tus pagos de deuda?",
        modules,
        estadio: "sobreviviendo"
      };
    }

    if (mencionaGastos && mencionaAhorro) {
      return {
        reply:
          "Gracias por decirlo. Esa combinaci√≥n ‚Äîgastos altos y poco ahorro‚Äî es m√°s com√∫n de lo que crees.\n\n" +
          "El siguiente paso ser√≠a identificar una sola categor√≠a donde podr√≠amos recuperar un poco mes a mes.\n\n" +
          "¬øHay alguna categor√≠a que te llame la atenci√≥n revisar primero?",
        modules,
        estadio: "sobreviviendo"
      };
    }

    if (mencionaDeuda && mencionaAhorro) {
      return {
        reply:
          "Gracias por compartirlo. Cuando hay deuda y poco ahorro, el foco es fortalecer la base poco a poco.\n\n" +
          "Lo siguiente ser√≠a entender tus pagos mensuales y ver si podemos crear un microahorro para darte un poco m√°s de estabilidad.\n\n" +
          "¬øDir√≠as que tus deudas principales son tarjetas, pr√©stamos personales o una mezcla?",
        modules,
        estadio: "asegurar"
      };
    }

    // 3) FRASES COMPLETAS CLAVE
    const frases = {
      deficit: [
        "gasto mas de lo que gano", "gasto m√°s de lo que gano",
        "no me alcanza", "no llego", "llego justo", "llego a penas"
      ],
      deudaAlta: [
        "tengo mucha deuda", "mucha deuda", "demasiada deuda",
        "solo pago los minimos", "solo pago m√≠nimos", "tarjetas al tope"
      ],
      sinAhorro: [
        "no ahorro", "no puedo ahorrar", "no me queda para ahorrar"
      ],
      sinReserva: [
        "no tengo reserva", "no tengo fondo", "no tengo emergencia"
      ]
    };

    for (const key in frases) {
      if (frases[key].some(f => text.includes(f))) {
        switch (key) {
          case "deficit":
            return {
              reply:
                "Cuando lo que sale es m√°s de lo que entra, el objetivo n√∫mero uno es claridad.\n\n" +
                "No hace falta cambiar todo a la vez. Empecemos por algo muy concreto: elegir una sola categor√≠a (por ejemplo, comidas fuera o suscripciones) y ver cu√°nto se est√° yendo ah√≠.\n\n" +
                "Con ese primer paso ya empezamos a recuperar control.",
              modules,
              estadio: "sobreviviendo"
            };
          case "deudaAlta":
            return {
              reply:
                "La deuda se puede sentir como una mochila pesada, y es normal que agote.\n\n" +
                "Antes de pensar en soluciones grandes, el siguiente paso es entender bien tu pago mensual total y cu√°nto de eso son tarjetas versus otros pr√©stamos.\n\n" +
                "¬øDir√≠as que el mayor peso viene de tarjetas, pr√©stamos personales o una mezcla de ambos?",
              modules,
              estadio: "asegurar"
            };
          case "sinAhorro":
            return {
              reply:
                "No eres la √∫nica persona a la que le pasa. Lo importante es c√≥mo lo manejamos a partir de hoy.\n\n" +
                "Mi sugerencia es empezar muy peque√±o: identificar una sola fuga de gasto donde puedas recuperar un poco cada mes para convertirlo en ahorro autom√°tico.\n\n" +
                "¬øHay alguna categor√≠a que sospeches que podr√≠amos revisar primero?",
              modules,
              estadio: "asegurar"
            };
          case "sinReserva":
            return {
              reply:
                "La reserva de emergencia da mucha tranquilidad, pero se construye poco a poco.\n\n" +
                "En vez de pensar en el n√∫mero completo, enfoqu√©monos en el primer tramo: llegar al primer mes de gastos esenciales cubiertos.\n\n" +
                "¬øC√≥mo sientes hoy tus gastos esenciales: muy ajustados, manejables o sin revisar?",
              modules,
              estadio: "asegurar"
            };
        }
      }
    }

    // 4) INTENCI√ìN FINANCIERA + META ESPEC√çFICA
    let foco = null;
    let metaEspecifica = null;

    if (text.includes("viaje") || text.includes("vacacion")) metaEspecifica = "un viaje";
    if (text.includes("carro") || text.includes("auto")) metaEspecifica = "un carro";
    if (text.includes("hijo") || text.includes("universidad") || text.includes("colegio")) metaEspecifica = "la educaci√≥n de tus hijos";

    if (text.includes("gasto")) foco = "tus gastos del mes";
    if (text.includes("deuda") || text.includes("tarjeta")) foco = "tus deudas y pagos mensuales";
    if (text.includes("reserva") || text.includes("emergencia")) foco = "tu liquidez y tu fondo de emergencia";
    if (text.includes("ahorro") || text.includes("guardar")) foco = "tu capacidad de ahorro";
    if (text.includes("ingreso") || text.includes("trabajo")) foco = "tus ingresos";
    if (text.includes("meta") || text.includes("objetivo")) foco = "tus metas financieras";
    if (text.includes("casa") || text.includes("propiedad")) foco = "tu meta de comprar casa";
    if (text.includes("retiro") || text.includes("jubil")) foco = "tu meta de retiro";

    // 5) ESTADIO FINANCIERO ESTIMADO
    let estadio = "asegurar";

    const hayDeficit = frases.deficit.some(f => text.includes(f));
    const hablaDeDeudas = text.includes("deuda") || text.includes("tarjeta");
    const hablaDeMetas = text.includes("meta") || metaEspecifica !== null || text.includes("retiro");

    if (hayDeficit) {
      estadio = "sobreviviendo";
    } else if (hablaDeDeudas && !hablaDeMetas) {
      estadio = "asegurar";
    } else if (hablaDeMetas || text.includes("ahorro")) {
      estadio = "acumular";
    }

    // 6) RESPUESA ADAPTADA AL FOCO + ESTADIO
    if (foco) {
      const intro = pick([
        "Gracias por compartir esto.",
        "Bien que lo pongas sobre la mesa.",
        "Es muy √∫til que lo digas con esta claridad."
      ]);

      const contexto = `Por lo que comentas, ahora mismo el enfoque principal est√° en **${foco}**.`;

      const mensajeEstadio = {
        sobreviviendo:
          "En esta etapa la prioridad es detener el descontrol y recuperar un poco de aire. No vamos a intentar arreglar todo a la vez, solo dar un primer paso claro.",
        asegurar:
          "Est√°s en un punto donde ordenar deudas, liquidez y h√°bitos puede hacer una gran diferencia en poco tiempo.",
        acumular:
          "Parece que ya tienes cierta base y ahora la conversaci√≥n empieza a ir m√°s hacia metas y acumulaci√≥n, siempre cuidando tu liquidez."
      }[estadio];

      let preguntaCierre = "¬øTe parece si empezamos revisando una sola parte de esa √°rea para ver qu√© se puede ajustar con calma?";

      if (foco === "tus gastos del mes") {
        preguntaCierre = "Si tuvieras que escoger una sola categor√≠a de gasto para revisar esta semana, ¬øcu√°l ser√≠a?";
      } else if (foco === "tus deudas y pagos mensuales") {
        preguntaCierre = "¬øSabes aproximadamente cu√°nto est√°s pagando al mes entre todas tus deudas?";
      } else if (foco === "tu liquidez y tu fondo de emergencia") {
        preguntaCierre = "¬øTienes idea de cu√°ntos meses de gastos podr√≠as cubrir hoy si ma√±ana se detuviera tu ingreso?";
      } else if (foco === "tu capacidad de ahorro") {
        preguntaCierre = "¬øPrefieres que veamos primero c√≥mo aumentar un poco tu ahorro o c√≥mo hacerlo m√°s constante?";
      } else if (foco === "tus ingresos") {
        preguntaCierre = "¬øLo que m√°s te preocupa es que el ingreso es bajo, inestable o que no se est√° administrando bien?";
      } else if (foco === "tus metas financieras") {
        preguntaCierre = "Si tuvieras que elegir una meta principal para los pr√≥ximos 12 meses, ¬øcu√°l ser√≠a?";
      } else if (foco === "tu meta de comprar casa") {
        preguntaCierre = "Para esa meta, es clave ver primero deuda, reserva y estabilidad de ingreso. ¬øTe gustar√≠a que empecemos por ah√≠?";
      } else if (foco === "tu meta de retiro") {
        preguntaCierre = "¬øQuieres que empecemos por entender en qu√© etapa est√°s hoy: sobreviviendo, asegurando o acumulando?";
      }

      const metaExtra = metaEspecifica
        ? `\n\nMencionas tambi√©n ${metaEspecifica}. Esa meta se puede trabajar mejor cuando tengamos clara tu base de gastos, deudas y ahorro.`
        : "";

      return {
        reply:
          intro + "\n\n" +
          contexto + "\n\n" +
          mensajeEstadio + metaExtra + "\n\n" +
          "Un buen siguiente paso es enfocarnos en un solo punto, no en todo al mismo tiempo. " +
          preguntaCierre,
        modules,
        estadio
      };
    }

    // ---------------------------------------------
    // MEMORIA SIMPLE ‚Äì RESERVA_EMERGENCIA_XAI
    // ---------------------------------------------
    if (lastActiveModule === "RESERVA_EMERGENCIA_XAI") {
      if (/\b(0|1|2|3|4|5|6|[0-9]+)\s*mes/.test(text) || text === "0" || text === "1" || text === "2") {

        const meses = text.match(/\d+/) ? parseInt(text.match(/\d+/)[0]) : null;

        if (meses === 0) {
          return {
            reply:
              "Gracias por compartirlo. Empezar desde cero es m√°s com√∫n de lo que crees.\n\n" +
              "El primer tramo clave es llegar a **1 mes de gastos esenciales**. " +
              "Podemos ver juntos qu√© categor√≠a te permitir√≠a recuperar un poco cada mes.\n\n" +
              "¬øC√≥mo sientes hoy tus gastos esenciales: muy ajustados, manejables o sin revisar?",
            modules: ["RESERVA_EMERGENCIA_XAI"],
            estadio: "asegurar"
          };
        }

        if (meses === 1) {
          return {
            reply:
              "Perfecto, ya tienes **1 mes de reserva**. Ese es un buen primer paso. üôå\n\n" +
              "El siguiente tramo suele ser apuntar a **2‚Äì3 meses**, dependiendo de tu estabilidad laboral y tus responsabilidades.\n\n" +
              "¬øSientes que podr√≠as ajustar alguna categor√≠a para avanzar hacia ese segundo mes?",
            modules: ["RESERVA_EMERGENCIA_XAI"],
            estadio: "asegurar"
          };
        }

        if (meses >= 2 && meses <= 5) {
          return {
            reply:
              `Muy bien, tienes **${meses} meses de reserva**. Eso ya te da buena estabilidad. üëç\n\n` +
              "Si te interesa, podemos explorar c√≥mo consolidar tu reserva y empezar a trabajar metas de ahorro m√°s grandes.\n\n" +
              "¬øQuieres avanzar hacia tus metas o reforzar primero este fondo?",
            modules: ["RESERVA_EMERGENCIA_XAI"],
            estadio: "asegurar"
          };
        }

        if (meses >= 6) {
          return {
            reply:
              `Excelente, tener **${meses} meses de reserva** te pone en una posici√≥n muy s√≥lida. üí™\n\n` +
              "Desde este punto el enfoque suele pasar a metas grandes: ahorro anual, invertir a largo plazo, o metas espec√≠ficas como viaje, casa o retiro.\n\n" +
              "¬øTe gustar√≠a trabajar en alguna meta concreta?",
            modules: ["RESERVA_EMERGENCIA_XAI"],
            estadio: "acumular"
          };
        }
      }
    }

    // ---------------------------------------------
    // MEMORIA SIMPLE ‚Äì METAS_FINANCIERAS_XAI
    // ---------------------------------------------
    if (lastActiveModule === "METAS_FINANCIERAS_XAI") {
      const isVeryShort = text.split(/\s+/).length <= 6;

      if (isVeryShort && !text.includes("gasto") && !text.includes("deuda")) {
        return {
          reply:
            "Perfecto, tomemos eso como tu meta principal por ahora. üéØ\n\n" +
            "Lo siguiente es aterrizarla un poco: podemos trabajar el plazo (por ejemplo, 6, 12 o 18 meses) " +
            "y cu√°nto podr√≠as destinar cada mes, aunque sea un monto peque√±o.\n\n" +
            "¬øVes esta meta m√°s para los pr√≥ximos 12 meses o para un plazo m√°s largo?",
          modules: ["METAS_FINANCIERAS_XAI"],
          estadio: "acumular"
        };
      }
    }

    // ---------------------------------------------
    // MEMORIA SIMPLE ‚Äì GASTOS_DESVIACIONES_XAI
    // ---------------------------------------------
    if (lastActiveModule === "GASTOS_DESVIACIONES_XAI") {
      const isShort = text.split(/\s+/).length <= 5;

      if (isShort) {
        return {
          reply:
            `Bien, enfoqu√©monos entonces en **${raw}**.\n\n` +
            "Un buen primer paso es anotar, durante una o dos semanas, cu√°nto se va ah√≠ sin juzgar. " +
            "Solo observar. Con esa informaci√≥n podemos decidir cu√°nto quieres recuperar de esa categor√≠a.\n\n" +
            "¬øTe ves registrando solo esa categor√≠a por unos d√≠as para empezar?",
          modules: ["GASTOS_DESVIACIONES_XAI"],
          estadio: "sobreviviendo"
        };
      }
    }

    // ---------------------------------------------
    // MEMORIA SIMPLE ‚Äì DEUDAS_XAI
    // ---------------------------------------------
    if (lastActiveModule === "DEUDAS_XAI") {
      if (text.includes("tarjeta") || text.includes("tarjetas")) {
        return {
          reply:
            "Gracias, eso ayuda. Si el mayor peso est√° en tarjetas, suele significar intereses m√°s altos.\n\n" +
            "El siguiente paso ser√≠a saber, aunque sea aproximado, cu√°nto est√°s pagando al mes entre todas tus tarjetas.\n\n" +
            "¬øTienes una idea de ese pago mensual total (aunque sea aproximada)?",
          modules: ["DEUDAS_XAI"],
          estadio: "asegurar"
        };
      }

      if (text.includes("prestamo") || text.includes("pr√©stamo")) {
        return {
          reply:
            "Perfecto, entonces el foco est√° m√°s en pr√©stamos.\n\n" +
            "Lo siguiente ser√≠a ver cu√°nto suman tus pagos mensuales de todos los pr√©stamos, " +
            "para entender qu√© parte de tu ingreso se va ah√≠.\n\n" +
            "¬øSabes aproximadamente cu√°nto pagas al mes entre todos tus pr√©stamos?",
          modules: ["DEUDAS_XAI"],
          estadio: "asegurar"
        };
      }

      const pagoMatch = raw.match(/\$?\s*([0-9][0-9.,]*)/);
      if (pagoMatch) {
        const pagoTexto = pagoMatch[1];

        return {
          reply:
            `Gracias, con eso ya tenemos una referencia: alrededor de **${pagoTexto} al mes** en deudas.\n\n` +
            "Con ese dato, el siguiente paso ser√≠a ver qu√© porcentaje de tu ingreso representa, " +
            "para entender si est√° muy pesado o manejable.\n\n" +
            "¬øTe gustar√≠a que lo trabajemos m√°s adelante con tus n√∫meros completos en la app?",
          modules: ["DEUDAS_XAI"],
          estadio: "asegurar"
        };
      }
    }

    // ---------------------------------------------
    // MEMORIA SIMPLE ‚Äì SUPERAVIT_DEFICIT_XAI
    // ---------------------------------------------
    if (lastActiveModule === "SUPERAVIT_DEFICIT_XAI") {
      const textoSimple = text.replace(/\s+/g, " ");

      if (textoSimple.includes("en rojo") || textoSimple.includes("rojo") || textoSimple.includes("no me alcanza")) {
        return {
          reply:
            "Gracias por decirlo tal cual. Estar casi siempre en rojo desgasta mucho.\n\n" +
            "Aqu√≠ la prioridad no es ahorrar todav√≠a, sino cerrar poco a poco ese hueco. " +
            "Y eso casi siempre empieza por una sola categor√≠a donde podamos recuperar algo.\n\n" +
            "Si tuvieras que se√±alar una categor√≠a que se te va de las manos, ¬øcu√°l ser√≠a?",
          modules: ["SUPERAVIT_DEFICIT_XAI"],
          estadio: "sobreviviendo"
        };
      }

      if (textoSimple.includes("me sobra") || textoSimple.includes("superavit") || textoSimple.includes("super√°vit")) {
        return {
          reply:
            "Muy bien, tener algo de super√°vit es una base importante. üëè\n\n" +
            "El siguiente paso ser√≠a decidir qu√© parte fijas como ahorro m√≠nimo y qu√© parte queda flexible.\n\n" +
            "¬øTe gustar√≠a destinar un porcentaje fijo de ese super√°vit a reserva o metas?",
          modules: ["SUPERAVIT_DEFICIT_XAI"],
          estadio: "asegurar"
        };
      }
    }

    // ---------------------------------------------
    // MEMORIA SIMPLE ‚Äì ESTADO_FINANCIERO_XAI
    // ---------------------------------------------
    if (lastActiveModule === "ESTADO_FINANCIERO_XAI") {
      const isShortEF = text.split(/\s+/).length <= 6;

      if (isShortEF && (text.includes("deuda") || text.includes("pasivo"))) {
        return {
          reply:
            "Entiendo, lo que m√°s te preocupa del estado financiero es el lado de las deudas/pasivos.\n\n" +
            "Una forma sencilla de verlo es: activos (lo que tienes) vs. pasivos (lo que debes) y tu patrimonio neto.\n\n" +
            "¬øHas llegado a calcular alguna vez tu patrimonio neto (activos menos deudas), aunque sea por encima?",
          modules: ["ESTADO_FINANCIERO_XAI"],
          estadio: "asegurar"
        };
      }

      if (isShortEF && (text.includes("activo") || text.includes("propiedad") || text.includes("casa"))) {
        return {
          reply:
            "Perfecto, entonces tu foco est√° en el lado de activos/propiedades.\n\n" +
            "Ver el estado financiero con calma ayuda a decidir si es momento de acumular m√°s liquidez, bajar deuda o seguir creciendo activos.\n\n" +
            "¬øSientes que hoy est√°s en modo m√°s defensivo (proteger lo que tienes) o ofensivo (crecer)?",
          modules: ["ESTADO_FINANCIERO_XAI"],
          estadio: "acumular"
        };
      }
    }

    // 7) RESPUESTA GENERAL
    const generales = [
      "Gracias por escribirme.",
      "Me alegra que lo est√©s hablando.",
      "Buen paso el que est√°s dando al ponerlo en palabras."
    ];

    return {
      reply:
        pick(generales) + " Para ayudarte mejor, dime si lo que comentas tiene m√°s que ver con gastos, deudas, ahorro, ingresos o alguna meta concreta.\n\n" +
        "Con eso puedo guiarte con pasos peque√±os y claros.",
      modules,
      estadio: null
    };
  }

  chatForm.addEventListener("submit", (event) => {
    event.preventDefault();
    const message = chatInput.value.trim();
    if (!message) return;

    appendMessage(message, "user");
    chatInput.value = "";
    chatInput.focus();

    sendBtn.disabled = true;
    sendBtn.textContent = "Pensando‚Ä¶";

    setTimeout(() => {
      const result = mockCoachXai(message);
      appendMessage(result.reply, "coach");

      const infoParts = [];
      if (result.estadio) {
        const cap = result.estadio.charAt(0).toUpperCase() + result.estadio.slice(1);
        infoParts.push("Estadio estimado (mock): " + cap);
      }
      if (result.modules && result.modules.length) {
        infoParts.push("M√≥dulos activos (mock): " + result.modules.join(", "));
      }
      if (lastActiveModule && !infoParts.join(" ").includes(lastActiveModule)) {
        infoParts.push("√öltimo m√≥dulo dominante: " + lastActiveModule);
      }

      if (infoParts.length) {
        appendInfo(infoParts.join(" ¬∑ "));
      }

      sendBtn.disabled = false;
      sendBtn.innerHTML = '<span class="icon">‚û§</span> Enviar';
    }, 400);
  });
</script>
</body>
</html>
